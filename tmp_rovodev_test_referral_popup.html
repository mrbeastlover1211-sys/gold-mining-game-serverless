<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Referral Popup</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    .test-section {
      background: #16213e;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      border: 2px solid #0f3460;
    }
    button {
      background: #00adb5;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #00d9ff;
    }
    .result {
      background: #0f3460;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196F3; }
    .warning { color: #FF9800; }
    h1 { color: #00adb5; }
    h2 { color: #00d9ff; }
    .link-box {
      background: #0f3460;
      padding: 10px;
      border-radius: 5px;
      word-break: break-all;
      margin: 10px 0;
      border: 1px solid #00adb5;
    }
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <h1>üéÅ Referral Popup Test Suite</h1>
  <p>This page tests the referral notification popup system</p>

  <div class="test-section">
    <h2>üìã How Referral Popup Works</h2>
    <div class="result">
<span class="info">1. User visits link with ?ref=WALLET_ADDRESS</span>
<span class="info">2. checkAndTrackReferral() runs on page load</span>
<span class="info">3. Tracking pixel sends request to /api/track-referral</span>
<span class="info">4. On success, showReferralTrackedNotification() displays popup</span>
<span class="info">5. Popup shows: "Referred by: ABC...XYZ"</span>
    </div>
  </div>

  <div class="test-section">
    <h2>Test 1: Simulate Referral Popup</h2>
    <p>Click to see what the popup looks like:</p>
    <button onclick="testShowPopup()">Show Referral Popup</button>
    <div id="test1-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Check Current URL for Referral</h2>
    <p>Check if current page has referral parameter:</p>
    <button onclick="testCheckURL()">Check URL</button>
    <div id="test2-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Test Track Referral API</h2>
    <p>Test if the API endpoint works:</p>
    <input type="text" id="testAddress" placeholder="Enter test wallet address" 
           style="width: 100%; padding: 10px; margin: 10px 0; background: #0f3460; border: 1px solid #00adb5; color: white; border-radius: 5px;"
           value="TestWallet1234567890ABCDEFGH">
    <button onclick="testTrackAPI()">Test Track API</button>
    <div id="test3-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: Generate Test Referral Links</h2>
    <p>Get test links to try:</p>
    <button onclick="generateTestLinks()">Generate Test Links</button>
    <div id="test4-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: Check localStorage for Referrer</h2>
    <p>Check if referrer is saved in localStorage:</p>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <button onclick="clearLocalStorage()">Clear localStorage</button>
    <div id="test5-result" class="result"></div>
  </div>

  <script>
    // Test 1: Show the popup
    function testShowPopup() {
      const result = document.getElementById('test1-result');
      result.innerHTML = 'üîÑ Showing popup...\n';

      const testAddress = '5YNmS1R9nNSCDzb5a7mMJ1dwK9uHQhz7yRzQnCJEVSmX';
      
      showReferralTrackedNotification(testAddress);
      
      result.innerHTML += '<span class="success">‚úÖ Popup shown! Check top-right corner of screen.</span>\n';
      result.innerHTML += `\nTest Address: ${testAddress}\n`;
      result.innerHTML += 'Popup will auto-close in 5 seconds.\n';
    }

    // Test 2: Check URL for referral parameter
    function testCheckURL() {
      const result = document.getElementById('test2-result');
      result.innerHTML = 'üîÑ Checking URL...\n\n';

      const urlParams = new URLSearchParams(window.location.search);
      const referrerAddress = urlParams.get('ref');

      result.innerHTML += `Current URL: ${window.location.href}\n\n`;

      if (referrerAddress && referrerAddress.length > 20) {
        result.innerHTML += '<span class="success">‚úÖ Referral parameter found!</span>\n';
        result.innerHTML += `Referrer: ${referrerAddress}\n`;
        result.innerHTML += `\nThe popup should have appeared automatically when you loaded this page.\n`;
      } else if (referrerAddress) {
        result.innerHTML += '<span class="warning">‚ö†Ô∏è Referral parameter found but too short</span>\n';
        result.innerHTML += `Value: ${referrerAddress}\n`;
        result.innerHTML += `Length: ${referrerAddress.length} (need >20)\n`;
      } else {
        result.innerHTML += '<span class="info">‚ÑπÔ∏è No referral parameter in URL</span>\n';
        result.innerHTML += '\nTo test, add ?ref=WALLET_ADDRESS to the URL\n';
        result.innerHTML += 'Example: ?ref=5YNmS1R9nNSCDzb5a7mMJ1dwK9uHQhz7yRzQnCJEVSmX\n';
      }
    }

    // Test 3: Test track API
    async function testTrackAPI() {
      const result = document.getElementById('test3-result');
      const testAddress = document.getElementById('testAddress').value;
      
      if (!testAddress || testAddress.length < 20) {
        result.innerHTML = '<span class="error">‚ùå Please enter a valid wallet address (>20 chars)</span>\n';
        return;
      }

      result.innerHTML = 'üîÑ Testing API...\n\n';
      result.innerHTML += `Test Address: ${testAddress}\n`;
      result.innerHTML += `API Endpoint: /api/track-referral?ref=${testAddress}\n\n`;

      try {
        // Use Image to track (same as production)
        const trackingPixel = new Image();
        const apiUrl = `/api/track-referral?ref=${encodeURIComponent(testAddress)}&t=${Date.now()}`;
        
        result.innerHTML += 'üì§ Sending request...\n';

        trackingPixel.onload = () => {
          result.innerHTML += '<span class="success">‚úÖ API call successful!</span>\n';
          result.innerHTML += '\nThe referral tracking pixel loaded successfully.\n';
          result.innerHTML += 'Referral session should be saved in database.\n';
          
          // Store in localStorage
          localStorage.setItem('gm_referrer', testAddress);
          result.innerHTML += '\nüíæ Saved to localStorage\n';
          
          // Show notification
          showReferralTrackedNotification(testAddress);
          result.innerHTML += '\nüéâ Notification popup displayed!\n';
        };

        trackingPixel.onerror = () => {
          result.innerHTML += '<span class="error">‚ùå API call failed</span>\n';
          result.innerHTML += '\nPossible reasons:\n';
          result.innerHTML += '- API endpoint not available\n';
          result.innerHTML += '- Network error\n';
          result.innerHTML += '- Server error\n';
        };

        trackingPixel.src = apiUrl;

      } catch (error) {
        result.innerHTML += `<span class="error">‚ùå Error: ${error.message}</span>\n`;
      }
    }

    // Test 4: Generate test links
    function generateTestLinks() {
      const result = document.getElementById('test4-result');
      
      const testAddresses = [
        '5YNmS1R9nNSCDzb5a7mMJ1dwK9uHQhz7yRzQnCJEVSmX',
        '7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU',
        'DYw8jCTfwHNRJhhmFcbXvVDTqWMEVFBX6ZKUmG5CNSKK'
      ];

      result.innerHTML = '<span class="info">üîó Test Referral Links:</span>\n\n';

      const baseUrl = window.location.origin;
      
      testAddresses.forEach((addr, index) => {
        const link = `${baseUrl}/?ref=${addr}`;
        result.innerHTML += `Test Link ${index + 1}:\n`;
        result.innerHTML += `<div class="link-box">${link}</div>\n`;
      });

      result.innerHTML += '\n<span class="success">üí° How to test:</span>\n';
      result.innerHTML += '1. Copy one of the links above\n';
      result.innerHTML += '2. Open in a new browser tab/window\n';
      result.innerHTML += '3. Popup should appear in top-right corner\n';
      result.innerHTML += '4. Check browser console for tracking logs\n';
    }

    // Test 5: Check localStorage
    function checkLocalStorage() {
      const result = document.getElementById('test5-result');
      result.innerHTML = 'üîç Checking localStorage...\n\n';

      const referrer = localStorage.getItem('gm_referrer');

      if (referrer) {
        result.innerHTML += '<span class="success">‚úÖ Referrer found in localStorage!</span>\n';
        result.innerHTML += `\nReferrer Address: ${referrer}\n`;
        result.innerHTML += `Length: ${referrer.length} characters\n`;
      } else {
        result.innerHTML += '<span class="info">‚ÑπÔ∏è No referrer in localStorage</span>\n';
        result.innerHTML += '\nThis is normal if:\n';
        result.innerHTML += '- You haven\'t visited with a referral link\n';
        result.innerHTML += '- localStorage was cleared\n';
        result.innerHTML += '- You\'re in incognito mode\n';
      }
    }

    function clearLocalStorage() {
      localStorage.removeItem('gm_referrer');
      const result = document.getElementById('test5-result');
      result.innerHTML = '<span class="success">‚úÖ localStorage cleared!</span>\n';
    }

    // Notification function (copy from main.js)
    function showReferralTrackedNotification(referrerAddress) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(45deg, #3B82F6, #1D4ED8);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        font-family: Arial, sans-serif;
        max-width: 300px;
        animation: slideIn 0.5s ease-out;
      `;
      
      notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">üéÅ Referral Tracked!</div>
        <div style="font-size: 12px; opacity: 0.9;">
          Referred by: ${referrerAddress.slice(0, 8)}...${referrerAddress.slice(-4)}
        </div>
        <div style="font-size: 11px; margin-top: 5px; opacity: 0.8;">
          Buy land to complete referral
        </div>
      `;
      
      document.body.appendChild(notification);
      
      console.log('üéâ Referral notification shown for:', referrerAddress);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
          console.log('üóëÔ∏è Notification removed');
        }
      }, 5000);
    }

    // Auto-check on page load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üß™ Referral Popup Test Suite Loaded');
      
      // Auto-check URL for referral parameter
      const urlParams = new URLSearchParams(window.location.search);
      const referrerAddress = urlParams.get('ref');
      
      if (referrerAddress && referrerAddress.length > 20) {
        console.log('üéÅ Auto-detected referral parameter:', referrerAddress);
        
        // Show notification automatically
        setTimeout(() => {
          showReferralTrackedNotification(referrerAddress);
          console.log('‚úÖ Auto-showed notification on page load');
        }, 1000);
      }
    });
  </script>
</body>
</html>
