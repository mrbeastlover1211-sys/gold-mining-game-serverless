<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Mining Game - Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
      min-height: 100vh;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 15px;
    }

    .admin-header h1 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #00d4aa;
    }

    .login-section {
      max-width: 400px;
      margin: 0 auto;
      padding: 30px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 15px;
      text-align: center;
    }

    .login-section input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(0, 212, 170, 0.3);
    }

    .login-section input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, #00d4aa, #00b894);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    .login-btn:hover {
      background: linear-gradient(45deg, #00b894, #00d4aa);
    }

    .dashboard {
      display: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid rgba(0, 212, 170, 0.3);
    }

    .stat-card h3 {
      font-size: 14px;
      color: #ccc;
      margin-bottom: 10px;
      text-transform: uppercase;
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #00d4aa;
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      border: 1px solid rgba(0, 212, 170, 0.3);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .tab-btn.active {
      background: rgba(0, 212, 170, 0.3);
      border-color: #00d4aa;
    }

    .tab-content {
      display: none;
      background: rgba(0, 0, 0, 0.4);
      padding: 20px;
      border-radius: 15px;
    }

    .tab-content.active {
      display: block;
    }

    .payouts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .payouts-table th,
    .payouts-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 212, 170, 0.2);
    }

    .payouts-table th {
      background: rgba(0, 212, 170, 0.2);
      font-weight: bold;
      color: #00d4aa;
    }

    .payouts-table tr:hover {
      background: rgba(0, 212, 170, 0.1);
    }

    .wallet-address {
      font-family: monospace;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .sol-input {
      width: 100px;
      padding: 5px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(0, 212, 170, 0.3);
      border-radius: 4px;
      color: white;
      text-align: center;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
      font-weight: bold;
    }

    .accept-btn {
      background: #22c55e;
      color: white;
    }

    .cancel-btn {
      background: #ef4444;
      color: white;
    }

    .action-btn:hover {
      opacity: 0.8;
    }

    .refresh-btn {
      padding: 10px 20px;
      background: rgba(0, 212, 170, 0.3);
      color: white;
      border: 1px solid #00d4aa;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .refresh-btn:hover {
      background: rgba(0, 212, 170, 0.5);
    }

    .message {
      padding: 10px 20px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .message.success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #22c55e;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      color: #ef4444;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #ccc;
    }

    @media (max-width: 768px) {
      .payouts-table {
        font-size: 12px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .nav-tabs {
        flex-wrap: wrap;
      }
      
      .sol-input {
        width: 80px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>üîß Gold Mining Game - Admin Panel</h1>
      <p>Manage payouts, view statistics, and monitor game activity</p>
      <div style="margin-top: 10px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; font-size: 12px;">
        <strong>Admin Access URL:</strong> /admin-panel.html | <strong>Game URL:</strong> <a href="/" target="_blank" style="color: #00d4aa;">üéÆ View Game</a>
      </div>
    </div>

    <!-- Login Section -->
    <div id="loginSection" class="login-section">
      <h2>Admin Access</h2>
      <input type="password" id="adminPassword" placeholder="Enter admin password" />
      <button class="login-btn" onclick="login()">üîê Login</button>
      <div id="loginMessage"></div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="dashboard">
      <!-- Statistics Overview -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Land Purchases</h3>
          <div class="value" id="landPurchases">0</div>
        </div>
        <div class="stat-card">
          <h3>Pickaxe Purchases (SOL)</h3>
          <div class="value" id="pickaxePurchases">0</div>
        </div>
        <div class="stat-card">
          <h3>Total SOL Received</h3>
          <div class="value" id="totalSolReceived">0.000000</div>
        </div>
        <div class="stat-card">
          <h3>Active Users</h3>
          <div class="value" id="activeUsers">0</div>
        </div>
        <div class="stat-card">
          <h3>Online Users</h3>
          <div class="value" id="onlineUsers">0</div>
        </div>
        <div class="stat-card">
          <h3>Pending Payouts</h3>
          <div class="value" id="pendingPayouts">0</div>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('overview')">üìä Overview</button>
        <button class="tab-btn" onclick="showTab('payouts')">üí∞ Pending Payouts</button>
      </div>

      <!-- Overview Tab -->
      <div id="overviewTab" class="tab-content active">
        <h2>üìä System Overview</h2>
        <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Stats</button>
        <p>Monitor your Gold Mining Game performance and user activity.</p>
        
        <div style="margin-top: 20px;">
          <h3>üéÆ Game Statistics</h3>
          <ul style="list-style: none; padding-left: 0; margin-top: 10px;">
            <li style="margin: 8px 0;">üè† <span id="landStat">0</span> players have purchased land</li>
            <li style="margin: 8px 0;">‚õèÔ∏è <span id="pickaxeStat">0</span> pickaxes bought with SOL</li>
            <li style="margin: 8px 0;">üí∞ <span id="solStat">0</span> SOL earned in total revenue</li>
            <li style="margin: 8px 0;">üë• <span id="activeStat">0</span> active players with land</li>
            <li style="margin: 8px 0;">üü¢ <span id="onlineStat">0</span> players online now</li>
          </ul>
        </div>
      </div>

      <!-- Payouts Tab -->
      <div id="payoutsTab" class="tab-content">
        <h2>üí∞ Pending Gold Sales</h2>
        <button class="refresh-btn" onclick="loadPendingPayouts()">üîÑ Refresh Payouts</button>
        <p>Review and process gold-to-SOL conversion requests.</p>
        
        <div id="payoutsContent">
          <div class="loading">Loading pending payouts...</div>
        </div>
      </div>
    </div>

    <div id="messageArea"></div>
  </div>

  <script>
    let adminPassword = '';
    
    function showMessage(text, type = 'info') {
      const messageArea = document.getElementById('messageArea');
      messageArea.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        messageArea.innerHTML = '';
      }, 5000);
    }

    async function login() {
      const password = document.getElementById('adminPassword').value;
      if (!password) {
        showMessage('Please enter admin password', 'error');
        return;
      }

      try {
        const response = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'dashboard', 
            password: password 
          })
        });

        console.log('Login response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Login failed - Status:', response.status, 'Response:', errorText);
          throw new Error(`Login failed: ${response.status} - ${errorText.slice(0, 100)}`);
        }

        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          const responseText = await response.text();
          console.error('JSON Parse Error:', parseError, 'Response:', responseText);
          throw new Error(`Invalid server response. Please check server logs.`);
        }
        
        if (data.success) {
          adminPassword = password;
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';
          showMessage('‚úÖ Admin access granted', 'success');
          loadDashboard();
        } else {
          showMessage('‚ùå ' + (data.error || 'Login failed'), 'error');
        }
      } catch (e) {
        console.error('Login error:', e);
        showMessage('‚ùå Login failed: ' + e.message, 'error');
      }
    }

    async function loadDashboard() {
      try {
        const response = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'dashboard', 
            password: adminPassword 
          })
        });

        const data = await response.json();
        
        if (data.success) {
          const stats = data.stats;
          document.getElementById('landPurchases').textContent = stats.land_purchases;
          document.getElementById('pickaxePurchases').textContent = stats.pickaxe_purchases;
          document.getElementById('totalSolReceived').textContent = stats.total_sol_received;
          document.getElementById('activeUsers').textContent = stats.active_users;
          document.getElementById('onlineUsers').textContent = stats.online_users;
          document.getElementById('pendingPayouts').textContent = stats.pending_payouts;
          
          // Update overview text
          document.getElementById('landStat').textContent = stats.land_purchases;
          document.getElementById('pickaxeStat').textContent = stats.pickaxe_purchases;
          document.getElementById('solStat').textContent = stats.total_sol_received + ' SOL';
          document.getElementById('activeStat').textContent = stats.active_users;
          document.getElementById('onlineStat').textContent = stats.online_users;
          
          showMessage('üìä Dashboard updated', 'success');
        } else {
          showMessage('‚ùå Failed to load dashboard: ' + data.error, 'error');
        }
      } catch (e) {
        showMessage('‚ùå Dashboard error: ' + e.message, 'error');
      }
    }

    async function loadPendingPayouts() {
      const payoutsContent = document.getElementById('payoutsContent');
      payoutsContent.innerHTML = '<div class="loading">Loading pending payouts...</div>';

      try {
        const response = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'pending_payouts', 
            password: adminPassword 
          })
        });

        const data = await response.json();
        
        if (data.success) {
          if (data.payouts.length === 0) {
            payoutsContent.innerHTML = '<p style="text-align: center; color: #ccc; padding: 20px;">No pending payouts</p>';
            return;
          }

          let tableHtml = `
            <table class="payouts-table">
              <thead>
                <tr>
                  <th>Wallet Address</th>
                  <th>Gold Amount</th>
                  <th>Original SOL</th>
                  <th>Edit SOL</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;

          data.payouts.forEach(payout => {
            const shortWallet = payout.wallet.slice(0, 8) + '...' + payout.wallet.slice(-4);
            const createdDate = new Date(payout.createdAt).toLocaleString();
            
            tableHtml += `
              <tr>
                <td><div class="wallet-address" title="${payout.wallet}">${shortWallet}</div></td>
                <td>${payout.goldAmount.toLocaleString()}</td>
                <td>${payout.solAmount.toFixed(6)}</td>
                <td><input type="number" class="sol-input" value="${payout.solAmount.toFixed(6)}" step="0.000001" id="sol_${payout.id}"></td>
                <td>${createdDate}</td>
                <td>
                  <button class="action-btn accept-btn" onclick="processPayout(${payout.id})">‚úÖ Accept</button>
                  <button class="action-btn cancel-btn" onclick="cancelPayout(${payout.id})">‚ùå Cancel</button>
                </td>
              </tr>
            `;
          });

          tableHtml += '</tbody></table>';
          payoutsContent.innerHTML = tableHtml;
          
        } else {
          payoutsContent.innerHTML = `<p style="color: #ef4444;">Failed to load payouts: ${data.error}</p>`;
        }
      } catch (e) {
        payoutsContent.innerHTML = `<p style="color: #ef4444;">Error: ${e.message}</p>`;
      }
    }

    async function processPayout(payoutId) {
      const solInput = document.getElementById(`sol_${payoutId}`);
      const editedAmount = parseFloat(solInput.value);
      
      if (!editedAmount || editedAmount <= 0) {
        showMessage('‚ùå Invalid SOL amount', 'error');
        return;
      }

      if (!confirm(`Send ${editedAmount} SOL to user?`)) {
        return;
      }

      try {
        showMessage('üí∞ Processing payout...', 'success');
        
        const response = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'process_payout', 
            password: adminPassword,
            payoutId: payoutId,
            editedSolAmount: editedAmount
          })
        });

        const data = await response.json();
        
        if (data.success) {
          showMessage(`‚úÖ ${data.message} (Tx: ${data.signature.slice(0, 8)}...)`, 'success');
          loadPendingPayouts();
          loadDashboard();
        } else {
          showMessage('‚ùå Payout failed: ' + data.error, 'error');
        }
      } catch (e) {
        showMessage('‚ùå Payout error: ' + e.message, 'error');
      }
    }

    async function cancelPayout(payoutId) {
      if (!confirm('Cancel this payout? User will lose gold and receive nothing!')) {
        return;
      }

      try {
        const response = await fetch('/api/admin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'cancel_payout', 
            password: adminPassword,
            payoutId: payoutId,
            reason: 'Cancelled by admin'
          })
        });

        const data = await response.json();
        
        if (data.success) {
          showMessage(`‚úÖ ${data.message}`, 'success');
          loadPendingPayouts();
          loadDashboard();
        } else {
          showMessage('‚ùå Cancel failed: ' + data.error, 'error');
        }
      } catch (e) {
        showMessage('‚ùå Cancel error: ' + e.message, 'error');
      }
    }

    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');

      // Load data if needed
      if (tabName === 'payouts') {
        loadPendingPayouts();
      }
    }

    // Auto-refresh every 30 seconds if logged in
    setInterval(() => {
      if (adminPassword && document.getElementById('dashboard').style.display !== 'none') {
        loadDashboard();
      }
    }, 30000);
  </script>
</body>
</html>