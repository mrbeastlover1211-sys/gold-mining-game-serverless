<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>â›ï¸ Gold Mining Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
</head>
<body>
  <div class="game-dashboard">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">
            <img src="assets/pickaxes/pickaxe-netherite-left.gif" alt="Mining" class="logo-pickaxe-gif">
          </div>
          <h1>GOLD MINING</h1>
        </div>
        <nav class="header-nav">
          <a href="#dashboard" class="nav-link active">ğŸ  Dashboard</a>
          <button class="nav-link how-it-works-btn" onclick="showHowItWorksModal()">â“ How it Works?</button>
        </nav>
      </div>
      <div class="header-buttons">
        <button id="v2ComingSoonBtn" class="v2-coming-soon-btn">ğŸ„ Christmas Edition</button>
        <button id="referBtn" class="refer-btn">ğŸ Refer & Earn</button>
        <button id="connectBtn" class="connect-btn">ğŸ”— Connect Wallet</button>
      </div>
    </header>

    <!-- Stats Panel -->
    <div class="stats-panel">
      <div class="panel-title">ğŸ“Š Your Stats</div>
      
      <div class="stat-item">
        <div class="stat-label">ğŸ’° Total Gold</div>
        <div id="totalGold" class="stat-value highlight">0</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">â›ï¸ Total Pickaxes</div>
        <div id="totalPickaxes" class="stat-value">0</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">âš¡ Mining Rate</div>
        <div id="miningRate" class="stat-value highlight">0/sec</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">ğŸ’ Gold Price</div>
        <div id="goldPrice" class="stat-value">0 SOL</div>
      </div>
      
      <div class="stat-item">
        <div class="stat-label">ğŸ“ˆ Min Trade</div>
        <div id="minSell" class="stat-value">0</div>
      </div>
    </div>

    <!-- Store Panel -->
    <div class="wallet-panel">
      <div class="panel-title">ğŸª Store</div>
      
      <div class="store-items">
        <div class="store-item">
          <div class="store-item-header">
            <div class="store-pickaxe-icon silver">
              <img src="assets/pickaxes/pickaxe-silver.png" alt="Silver Pickaxe" style="width: 20px; height: 20px; object-fit: contain;">
            </div>
            <div class="store-item-info">
              <div class="store-item-name">Silver Pickaxe</div>
              <div class="store-item-rate">+1 gold/min</div>
            </div>
          </div>
          <div class="store-price">5,000 Gold</div>
          <button class="store-buy-btn" onclick="buyPickaxeWithGold('silver', 5000)">
            ğŸ›’ Buy Silver
          </button>
        </div>
        
        <div class="store-item">
          <div class="store-item-header">
            <div class="store-pickaxe-icon gold">
              <img src="assets/pickaxes/pickaxe-gold.png" alt="Gold Pickaxe" style="width: 20px; height: 20px; object-fit: contain;">
            </div>
            <div class="store-item-info">
              <div class="store-item-name">Gold Pickaxe</div>
              <div class="store-item-rate">+10 gold/min</div>
            </div>
          </div>
          <div class="store-price">20,000 Gold</div>
          <button class="store-buy-btn" onclick="buyPickaxeWithGold('gold', 20000)">
            ğŸ›’ Buy Gold
          </button>
        </div>
      </div>
      
      <!-- Store Status Message -->
      <div id="storeMsg" class="store-message"></div>
    </div>

    <!-- Shop Panel -->
    <div class="shop-panel">
      <div class="panel-title">ğŸ›’ Pickaxe Shop</div>
      <div class="pickaxe-grid" id="pickaxeGrid">
        <!-- Pickaxes will be populated by JavaScript -->
      </div>
      <div id="shopMsg" class="msg"></div>
    </div>

    <!-- Mining Panel -->
    <div class="mining-panel">
      <div class="panel-title">
        <img src="assets/pickaxes/pickaxe-netherite.gif" alt="Mining" class="title-pickaxe-gif"> Mining Operation
      </div>
      <div class="mining-display">
        <div class="mining-icon">
          <img src="assets/pickaxes/pickaxe-netherite.gif" alt="Mining" class="mining-title-gif">
        </div>
        <div id="currentMiningRate" class="mining-rate">+0 gold/sec</div>
        <div id="miningStatus" class="mining-status">Ready to start mining!</div>
      </div>
      
      <div class="simple-inventory">
        <div class="inventory-title">Your Pickaxes:</div>
        <div id="pickaxeInventoryGrid" class="pickaxe-inventory-grid">
          <div class="inventory-item" data-type="silver">
            <div class="inventory-icon silver">
              <img src="assets/pickaxes/pickaxe-silver.png" alt="Silver" class="pickaxe-mini-icon">
            </div>
            <div class="inventory-count" id="silver-count">0</div>
          </div>
          <div class="inventory-item" data-type="gold">
            <div class="inventory-icon gold">
              <img src="assets/pickaxes/pickaxe-gold.png" alt="Gold" class="pickaxe-mini-icon">
            </div>
            <div class="inventory-count" id="gold-count">0</div>
          </div>
          <div class="inventory-item" data-type="diamond">
            <div class="inventory-icon diamond">
              <img src="assets/pickaxes/pickaxe-diamond.png" alt="Diamond" class="pickaxe-mini-icon">
            </div>
            <div class="inventory-count" id="diamond-count">0</div>
          </div>
          <div class="inventory-item" data-type="netherite">
            <div class="inventory-icon netherite">
              <img src="assets/pickaxes/pickaxe-netherite.gif" alt="Netherite" class="pickaxe-mini-icon">
            </div>
            <div class="inventory-count" id="netherite-count">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selling Panel -->
    <div class="selling-panel">
      <div class="panel-title">ğŸ’° Sell Gold</div>
      <input type="number" id="sellAmount" class="sell-input" placeholder="Enter gold amount to sell" />
      <button id="sellBtn" class="sell-btn">ğŸ’° Sell Gold for SOL</button>
      <div id="sellMsg" class="msg"></div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-left">
        <div class="footer-info">
          ğŸ® Powered by Solana Blockchain<br>
          âš¡ Real-time mining â€¢ ğŸ”’ Secure transactions
        </div>
      </div>
      <div class="footer-right">
        <div class="network-status">
          <div class="status-dot"></div>
          <span>Solana Devnet</span>
        </div>
        <div class="footer-stats">
          <div>Version 1.0.0</div>
          <div id="footerStats">Total Players: Loading...</div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Land Purchase Modal -->
  <div id="landModal" class="modal-overlay mandatory-modal">
    <div class="modal-content land-modal">
      <div class="modal-header land-header">
        <h2>ğŸï¸ Welcome to Gold Mining!</h2>
        <!-- No close button - mandatory modal -->
      </div>
      
      <div class="modal-body">
        <div class="land-hero">
          <div class="land-icon">ğŸï¸</div>
          <h3>Purchase Your Mining Land</h3>
          <p>Before you can start mining gold and earning SOL, you need to purchase a mining plot!</p>
        </div>

        <div class="land-features">
          <div class="feature-item">
            <div class="feature-icon">â›ï¸</div>
            <div class="feature-text">
              <strong>Unlimited Mining Rights</strong>
              <p>Mine gold 24/7 with any pickaxe you own</p>
            </div>
          </div>
          
          <div class="feature-item">
            <div class="feature-icon">ğŸ›’</div>
            <div class="feature-text">
              <strong>Access to Shop</strong>
              <p>Buy powerful pickaxes to start your mining operation</p>
            </div>
          </div>
          
          <div class="feature-item">
            <div class="feature-icon">ğŸ”„</div>
            <div class="feature-text">
              <strong>One-Time Payment</strong>
              <p>Pay once, mine forever - no recurring fees!</p>
            </div>
          </div>
          
          <div class="feature-item">
            <div class="feature-icon">ğŸš€</div>
            <div class="feature-text">
              <strong>Instant Access</strong>
              <p>Start mining immediately after purchase</p>
            </div>
          </div>
        </div>

        <div class="land-price-section">
          <div class="price-box">
            <div class="price-label">Mining Land Price</div>
            <div class="price-amount">0.01 SOL</div>
          </div>
        </div>

        <div class="land-benefits">
          <h4>ğŸ¯ What You Get:</h4>
          <ul>
            <li>âœ… Permanent mining rights</li>
            <li>âœ… Access to pickaxe shop</li>
            <li>âœ… Access to all game features</li>
            <li>âœ… Referral system eligibility</li>
            <li>âœ… Future updates & features</li>
          </ul>
        </div>

        <button id="purchaseLandBtn" class="land-purchase-btn" onclick="purchaseLand()">
          ğŸï¸ Purchase Mining Land (0.01 SOL)
        </button>
        
        <div id="landMsg" class="msg"></div>
        
        <div class="land-disclaimer">
          <p>ğŸ”’ Secure payment via Solana blockchain â€¢ One-time setup fee â€¢ No hidden charges</p>
        </div>
      </div>
    </div>
  </div>

  <!-- How it Works Modal -->
  <div id="howItWorksModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>â“ How it Works?</h2>
        <button class="modal-close" onclick="hideHowItWorksModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="how-it-works-hero">
          <div class="how-it-works-icon">âš¡</div>
          <p>Simple 3-step process to start earning SOL!</p>
        </div>
        
        <div class="steps-container">
          <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-icon">ğŸ›’</div>
              <h3>Buy Pickaxe to Start Gold Mining</h3>
              <p>Purchase your first pickaxe to begin mining gold. Different pickaxes mine at different rates - start with Silver and upgrade as you earn!</p>
            </div>
          </div>
          
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-icon">â›ï¸</div>
              <h3>Mine Gold and Buy More Pickaxes</h3>
              <p>Watch your gold accumulate automatically! Use your earnings to buy more powerful pickaxes for faster mining rates.</p>
            </div>
          </div>
          
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-icon">ğŸ’°</div>
              <h3>Sell Gold and Get SOL Anytime</h3>
              <p>Convert your mined gold to SOL whenever you want! Instant withdrawals available 24/7 to your connected wallet.</p>
            </div>
          </div>
        </div>
        
        <div class="how-it-works-cta">
          <button class="start-mining-btn" onclick="hideHowItWorksModal()">ğŸš€ Start Mining Now!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- V2.0 Coming Soon Modal -->
  <div id="v2ComingSoonModal" class="modal-overlay">
    <div class="modal-content v2-modal">
      <div class="modal-header v2-header">
        <h2>ğŸ„ Christmas Edition Features ğŸ…</h2>
        <button class="modal-close" onclick="closeV2Modal()">Ã—</button>
      </div>
      
      <div class="modal-body">
        <div class="v2-hero">
          <div class="v2-icon">ğŸ„âœ¨</div>
          <h3>Experience the Magic of Christmas Mining!</h3>
          <p>Ho ho ho! Enjoy our festive Christmas-themed mining adventure! ğŸ…</p>
        </div>

        <div class="v2-features">
          <div class="v2-feature-item success">
            <div class="feature-icon">ğŸ</div>
            <div class="feature-text">
              <strong>Christmas Gift System</strong>
              <p>Find magical Christmas gifts while mining! Open them for bonus gold and special rewards! ğŸ€</p>
            </div>
          </div>
          
          <div class="v2-feature-item info">
            <div class="feature-icon">â„ï¸</div>
            <div class="feature-text">
              <strong>Winter Wonderland Mines</strong>
              <p>Mine in beautiful snowy landscapes with festive decorations and holiday music! â›„</p>
            </div>
          </div>
          
          <div class="v2-feature-item success">
            <div class="feature-icon">ğŸ…</div>
            <div class="feature-text">
              <strong>Santa's Workshop Bonus</strong>
              <p>Help Santa's elves and earn special Christmas pickaxes with holiday magic! ğŸ§â€â™€ï¸âœ¨</p>
            </div>
          </div>
          
          <div class="v2-feature-item info">
            <div class="feature-icon">ğŸ„</div>
            <div class="feature-text">
              <strong>Holiday Special Events</strong>
              <p>Join Christmas mining events for exclusive rewards and festive surprises! ğŸŠğŸ†</p>
            </div>
          </div>
        </div>

        <div class="christmas-info-box">
          <h4>ğŸ„ About Christmas Edition</h4>
          <p>Experience the magic of Christmas in our gold mining adventure! This special edition includes festive decorations, holiday-themed items, and exclusive Christmas rewards. Mine gold while enjoying the Christmas spirit!</p>
        </div>

        <div class="v2-cta">
          <button class="v2-notify-btn" onclick="closeV2Modal()">
            ğŸ„ Start Christmas Mining!
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Referral Modal -->
  <div id="referralModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ Refer & Earn Free Pickaxes!</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="referral-hero">
          <div class="referral-icon">ğŸš€</div>
          <p>Refer your friends and get <strong>FREE PICKAXES</strong>!</p>
          <p>The more referrals, the more pickaxes you earn!</p>
        </div>

        <div class="referral-rewards">
          <div class="reward-tier">
            <div class="tier-icon">ğŸ¥ˆ</div>
            <div class="tier-info">
              <div class="tier-count">1-10 Referrals</div>
              <div class="tier-reward">Free Silver Pickaxe + 100 Gold</div>
            </div>
          </div>
          
          <div class="reward-tier">
            <div class="tier-icon">ğŸ¥‡</div>
            <div class="tier-info">
              <div class="tier-count">11-17 Referrals</div>
              <div class="tier-reward">Free Gold Pickaxe + 100 Gold</div>
            </div>
          </div>
          
          <div class="reward-tier">
            <div class="tier-icon">ğŸ’</div>
            <div class="tier-info">
              <div class="tier-count">18-24 Referrals</div>
              <div class="tier-reward">Free Diamond Pickaxe + 100 Gold</div>
            </div>
          </div>
          
          <div class="reward-tier">
            <div class="tier-icon">ğŸŒŸ</div>
            <div class="tier-info">
              <div class="tier-count">25+ Referrals</div>
              <div class="tier-reward">Free Netherite Pickaxe + 100 Gold</div>
            </div>
          </div>
        </div>
        

        <div class="referral-link-section">
          <label for="referralLink">Your Referral Link:</label>
          <div class="link-container">
            <input type="text" id="referralLink" readonly value="Connect wallet to get your referral link..." />
            <button id="copyLinkBtn" class="copy-btn">ğŸ“‹ Copy</button>
          </div>
        </div>

        <div class="referral-stats" style="display: flex; justify-content: center;">
          <div class="stat-box">
            <div class="stat-number" id="totalReferrals">0</div>
            <div class="stat-label">Total Referrals</div>
          </div>
        </div>

        <div class="social-share">
          <p>Share on social media:</p>
          <div class="social-buttons">
            <button class="social-btn x" id="shareX">ğ• X</button>
            <button class="social-btn discord" id="shareDiscord">ğŸ’¬ Discord</button>
            <button class="social-btn telegram" id="shareTelegram">ğŸ“± Telegram</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="mining-engine.js"></script>
  <script src="main.js"></script>
  
  <!-- ğŸ¯ FIXED SESSION TRACKING REFERRAL SYSTEM -->
  <script>
    // Enhanced referral tracking with proper session management
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get('ref');
      
      if (ref && ref.length > 20) { // Valid wallet address length
        console.log('ğŸ”— Referral detected, tracking visit...', ref.slice(0, 8) + '...');
        
        // Store referrer in localStorage as backup
        localStorage.setItem('referrer_address', ref);
        localStorage.setItem('referral_timestamp', Date.now().toString());
        
        // Load tracking pixel to log the visit
        const trackingPixel = new Image();
        trackingPixel.src = `/api/track-referral?ref=${encodeURIComponent(ref)}&t=${Date.now()}`;
        
        // Enhanced tracking with session persistence
        trackingPixel.onload = function() {
          console.log('âœ… Referral visit tracked successfully');
          localStorage.setItem('referral_tracked', 'true');
        };
        
        trackingPixel.onerror = function() {
          console.log('âš ï¸ Referral tracking failed, stored locally');
        };
        
        // Clean URL after tracking but preserve session data
        if (window.history && window.history.replaceState) {
          setTimeout(() => {
            window.history.replaceState({}, document.title, window.location.pathname);
          }, 2000); // Longer delay for tracking to complete
        }
        
        console.log('âœ… Enhanced referral tracking initiated');
      }
      
      // Check for existing referral data on page load
      const storedReferrer = localStorage.getItem('referrer_address');
      const trackingTime = localStorage.getItem('referral_timestamp');
      
      if (storedReferrer && trackingTime) {
        const hoursAgo = (Date.now() - parseInt(trackingTime)) / (1000 * 60 * 60);
        if (hoursAgo < 48) { // Within 48 hours
          console.log('ğŸ” Found stored referral data:', {
            referrer: storedReferrer.slice(0, 8) + '...',
            hoursAgo: hoursAgo.toFixed(1)
          });
          window.pendingReferral = {
            referrerAddress: storedReferrer,
            timestamp: trackingTime
          };
        } else {
          // Clean expired referral data
          localStorage.removeItem('referrer_address');
          localStorage.removeItem('referral_timestamp');
          localStorage.removeItem('referral_tracked');
        }
      }
    })();
  </script>
</body>
</html>