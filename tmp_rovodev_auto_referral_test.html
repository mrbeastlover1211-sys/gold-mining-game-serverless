<!DOCTYPE html>
<html>
<head>
    <title>ğŸ Auto Referral System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .step { background: #f8fafc; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 4px solid #10b981; }
        .result { margin: 15px 0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .error { background: #fef2f2; border: 1px solid #ef4444; color: #7f1d1d; }
        .info { background: #f0f9ff; border: 1px solid #3b82f6; color: #1e3a8a; }
        button { background: #10b981; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 10px 5px; }
        button:hover { background: #059669; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ Automatic Referral System Test</h1>
        
        <div class="step">
            <h3>ğŸ¯ Your Test Setup</h3>
            <p><strong>Main Account (gets rewards):</strong> <code>4VqgEAYvNWe1hCMBhNsvs1ng1Ai1mwihkzjBzSQBSSKa</code></p>
            <p><strong>Test Referral Link:</strong></p>
            <p><a href="https://gold-mining-game-serverless.vercel.app/?ref=4VqgEAYvNWe1hCMBhNsvs1ng1Ai1mwihkzjBzSQBSSKa" target="_blank">
                https://gold-mining-game-serverless.vercel.app/?ref=4VqgEAYvNWe1hCMBhNsvs1ng1Ai1mwihkzjBzSQBSSKa
            </a></p>
        </div>
        
        <div class="step">
            <h3>ğŸ“‹ Manual Test Instructions</h3>
            <ol>
                <li><strong>Open referral link in incognito browser</strong></li>
                <li><strong>Open browser console</strong> (F12 â†’ Console tab)</li>
                <li><strong>Look for tracking logs</strong>: "Referral visit tracked successfully"</li>
                <li><strong>Connect a NEW wallet</strong> (not your main account)</li>
                <li><strong>Look for session logs</strong>: "Referral session linked successfully"</li>
                <li><strong>Buy land + pickaxe</strong></li>
                <li><strong>Look for completion logs</strong>: "Referral completed successfully!"</li>
                <li><strong>Check your main account</strong> for rewards</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>ğŸ” Debug Your Main Account</h3>
            <button onclick="checkMainAccount()">ğŸ“Š Check Main Account Status</button>
            <div id="mainAccountResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ§ª Test Completion API</h3>
            <p>Enter wallet address that completed land + pickaxe purchase:</p>
            <input type="text" id="completedWallet" placeholder="Enter wallet address..." style="width: 100%; padding: 8px; margin: 10px 0;">
            <button onclick="testCompletion()">ğŸ Test Completion</button>
            <div id="completionResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="step">
            <h3>ğŸ”— Check Recent Referral Activity</h3>
            <button onclick="checkDatabase()">ğŸ“ˆ View Database Activity</button>
            <div id="databaseResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="step" style="background: #fff3cd; border-left-color: #ffc107;">
            <h3>âš ï¸ Common Issues</h3>
            <ul>
                <li><strong>Session Lost</strong>: Use same browser tab, don't close/reopen</li>
                <li><strong>Cache Issues</strong>: Try hard refresh (Ctrl+F5)</li>
                <li><strong>Wrong Wallets</strong>: Don't use main account to test with itself</li>
                <li><strong>Deployment Lag</strong>: Wait 2-3 minutes after code changes</li>
            </ul>
        </div>
    </div>

    <script>
        const API_BASE = 'https://gold-mining-game-serverless.vercel.app';
        const MAIN_ACCOUNT = '4VqgEAYvNWe1hCMBhNsvs1ng1Ai1mwihkzjBzSQBSSKa';
        
        async function checkMainAccount() {
            const resultDiv = document.getElementById('mainAccountResult');
            showResult(resultDiv, 'ğŸ”„ Checking main account...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/status?address=${MAIN_ACCOUNT}`);
                const data = await response.json();
                
                let result = `ğŸ“Š MAIN ACCOUNT STATUS\n\n`;
                result += `Address: ${MAIN_ACCOUNT}\n`;
                result += `Has Land: ${data.hasLand}\n`;
                result += `Pickaxes: Silver=${data.inventory?.silver || 0}, Gold=${data.inventory?.gold || 0}, Diamond=${data.inventory?.diamond || 0}, Netherite=${data.inventory?.netherite || 0}\n`;
                result += `Current Gold: ${data.gold}\n`;
                result += `Total Referrals: ${data.referralStats?.totalReferrals || 0}\n`;
                result += `Referral Gold Earned: ${data.referralStats?.referralGoldEarned || 0}\n\n`;
                
                if (data.referralStats?.totalReferrals > 0) {
                    result += `âœ… REFERRALS ARE WORKING! Total: ${data.referralStats.totalReferrals}`;
                    showResult(resultDiv, result, 'success');
                } else {
                    result += `âŒ NO REFERRALS COMPLETED YET\nEither no one has used your referral link, or automatic completion isn't working.`;
                    showResult(resultDiv, result, 'error');
                }
                
            } catch (error) {
                showResult(resultDiv, `âŒ Error checking main account: ${error.message}`, 'error');
            }
        }
        
        async function testCompletion() {
            const resultDiv = document.getElementById('completionResult');
            const walletAddress = document.getElementById('completedWallet').value;
            
            if (!walletAddress) {
                showResult(resultDiv, 'âŒ Please enter a wallet address', 'error');
                return;
            }
            
            showResult(resultDiv, 'ğŸ”„ Testing completion...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/complete-referral`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: walletAddress })
                });
                
                const data = await response.json();
                
                let result = `ğŸ COMPLETION TEST RESULT\n\n`;
                result += `Success: ${data.success}\n`;
                result += `Completed: ${data.referral_completed}\n`;
                result += `Message: ${data.message}\n\n`;
                
                if (data.success && data.referral_completed) {
                    result += `ğŸ‰ SUCCESS! Referral completion worked!\n`;
                    result += `Check your main account for new rewards.`;
                    showResult(resultDiv, result, 'success');
                } else {
                    result += `âŒ COMPLETION FAILED\n`;
                    result += `Reason: ${data.message}`;
                    showResult(resultDiv, result, 'error');
                }
                
            } catch (error) {
                showResult(resultDiv, `âŒ Completion test failed: ${error.message}`, 'error');
            }
        }
        
        async function checkDatabase() {
            const resultDiv = document.getElementById('databaseResult');
            showResult(resultDiv, 'ğŸ”„ Checking database...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/debug-referral-database`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    let result = `ğŸ“Š DATABASE STATUS\n\n`;
                    if (data.statistics) {
                        result += `Total Referrals: ${data.statistics.total_referrals || 0}\n`;
                        result += `Active Sessions: ${data.statistics.active_sessions || 0}\n`;
                        result += `Completed: ${data.statistics.completed_referrals || 0}\n\n`;
                    }
                    
                    if (data.recent_activity && data.recent_activity.length > 0) {
                        result += `Recent Activity:\n`;
                        data.recent_activity.slice(0, 3).forEach(activity => {
                            result += `${activity.visit_timestamp}: ${activity.referrer_address?.slice(0, 8)}... â†’ ${activity.converted_address?.slice(0, 8) || 'Not converted'}\n`;
                        });
                    } else {
                        result += `No recent referral activity found`;
                    }
                    
                    showResult(resultDiv, result, 'success');
                } else {
                    showResult(resultDiv, `Database API returned: ${response.status} ${response.statusText}`, 'error');
                }
                
            } catch (error) {
                showResult(resultDiv, `âŒ Database check failed: ${error.message}`, 'error');
            }
        }
        
        function showResult(element, text, type) {
            element.innerHTML = `<pre>${text}</pre>`;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
        
        // Auto-check main account on page load
        window.addEventListener('load', () => {
            setTimeout(checkMainAccount, 1000);
        });
    </script>
</body>
</html>