<!DOCTYPE html>
<html>
<head>
    <title>Test Referral System</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ Referral System Testing Tool</h1>
        <p>Use this tool to test and debug the referral system for your Christmas Gold Mining Game.</p>
        
        <div class="test-section">
            <h3>ğŸ” 1. Test Manual Referral Completion</h3>
            <p>Test the referral system with specific wallet addresses:</p>
            <div>
                <input type="text" id="referrerAddress" placeholder="Referrer wallet address (who gets reward)" value="67agGdBaroRL6SJguYT13eVMkWGCegfFbQgnHaJub45C">
                <input type="text" id="refereeAddress" placeholder="Referee wallet address (who was referred)" value="9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM">
            </div>
            <button onclick="testManualReferral()">ğŸ§ª Test Manual Referral</button>
            <div id="manualResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š 2. Check Database State</h3>
            <p>View current referral database state:</p>
            <button onclick="checkDatabase()">ğŸ” Check Referral Database</button>
            <div id="databaseResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ¯ 3. Test Referral Completion API</h3>
            <p>Test the current referral completion endpoint:</p>
            <input type="text" id="testAddress" placeholder="Test wallet address" value="9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM">
            <button onclick="testReferralCompletion()">ğŸ Test Completion API</button>
            <div id="completionResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ 4. Test New Referral System</h3>
            <p>Test the referral-system-complete endpoint:</p>
            <input type="text" id="newTestAddress" placeholder="Test wallet address" value="9WzDXwBbmkg8ZTbNMqUxvQRAyrZzDsGYdLVL9zYtAWWM">
            <button onclick="testNewReferralSystem()">âœ¨ Test New System</button>
            <div id="newSystemResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://gold-mining-serverless-5yrzhrw4u-james-projects-c1b8b251.vercel.app';
        
        async function testManualReferral() {
            const referrer = document.getElementById('referrerAddress').value.trim();
            const referee = document.getElementById('refereeAddress').value.trim();
            const resultDiv = document.getElementById('manualResult');
            
            if (!referrer || !referee) {
                showResult(resultDiv, 'âŒ Please enter both wallet addresses', 'error');
                return;
            }
            
            showResult(resultDiv, 'ğŸ”„ Testing manual referral completion...', '');
            
            try {
                const response = await fetch(`${API_BASE}/api/manual-test-referral`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        referrer_address: referrer,
                        referee_address: referee,
                        action: 'test_complete'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let result = `âœ… MANUAL REFERRAL TEST RESULTS:\n\n`;
                    result += `ğŸ‘¥ USERS:\n`;
                    result += `Referrer: ${data.users.referrer.address}\n`;
                    result += `  - Gold: ${data.users.referrer.gold_before} â†’ ${data.users.referrer.gold_after}\n`;
                    result += `  - Referrals: ${data.users.referrer.total_referrals_before} â†’ ${data.users.referrer.total_referrals_after}\n\n`;
                    result += `Referee: ${data.users.referee.address}\n`;
                    result += `  - Has Land: ${data.users.referee.has_land}\n`;
                    result += `  - Pickaxes: ${data.users.referee.total_pickaxes}\n\n`;
                    result += `ğŸ“ NEXT STEPS: ${data.next_steps}`;
                    
                    showResult(resultDiv, result, 'success');
                } else {
                    showResult(resultDiv, `âŒ Test failed: ${data.error}\nDetails: ${data.details}`, 'error');
                }
                
            } catch (error) {
                showResult(resultDiv, `âŒ Request failed: ${error.message}`, 'error');
            }
        }
        
        async function checkDatabase() {
            const resultDiv = document.getElementById('databaseResult');
            showResult(resultDiv, 'ğŸ”„ Checking database state...', '');
            
            try {
                const response = await fetch(`${API_BASE}/api/debug-referral-database`);
                const data = await response.json();
                
                if (data.success) {
                    let result = `ğŸ“Š DATABASE STATE:\n\n`;
                    result += `Total Visits: ${data.statistics.total_visits}\n`;
                    result += `Converted Sessions: ${data.statistics.converted_sessions}\n`;
                    result += `Completed Referrals: ${data.statistics.completed_referrals}\n`;
                    result += `Ready for Completion: ${data.statistics.ready_for_completion}\n\n`;
                    
                    if (data.potential_completions.length > 0) {
                        result += `ğŸ¯ POTENTIAL COMPLETIONS:\n`;
                        data.potential_completions.forEach((comp, i) => {
                            result += `${i + 1}. ${comp.referrer} â†’ ${comp.referee}\n`;
                            result += `   Land: ${comp.has_land}, Pickaxes: ${comp.total_pickaxes}, Ready: ${comp.ready_for_completion}\n`;
                        });
                    }
                    
                    showResult(resultDiv, result, 'success');
                } else {
                    showResult(resultDiv, `âŒ Database check failed: ${data.error}`, 'error');
                }
                
            } catch (error) {
                showResult(resultDiv, `âŒ Request failed: ${error.message}`, 'error');
            }
        }
        
        async function testReferralCompletion() {
            const address = document.getElementById('testAddress').value.trim();
            const resultDiv = document.getElementById('completionResult');
            
            if (!address) {
                showResult(resultDiv, 'âŒ Please enter a wallet address', 'error');
                return;
            }
            
            showResult(resultDiv, 'ğŸ”„ Testing referral completion API...', '');
            
            try {
                const response = await fetch(`${API_BASE}/api/complete-referral?address=${encodeURIComponent(address)}`);
                const data = await response.json();
                
                let result = `ğŸ“‹ REFERRAL COMPLETION API RESULT:\n\n`;
                result += `Success: ${data.success}\n`;
                result += `Message: ${data.message || 'No message'}\n`;
                result += `Referral Completed: ${data.referral_completed || false}\n`;
                
                if (data.reward_details) {
                    result += `\nğŸ REWARD DETAILS:\n`;
                    result += `Gold Reward: ${data.reward_details.gold_reward}\n`;
                    result += `Pickaxe Reward: ${data.reward_details.pickaxe_reward}\n`;
                }
                
                showResult(resultDiv, result, data.success ? 'success' : 'error');
                
            } catch (error) {
                showResult(resultDiv, `âŒ API test failed: ${error.message}`, 'error');
            }
        }
        
        async function testNewReferralSystem() {
            const address = document.getElementById('newTestAddress').value.trim();
            const resultDiv = document.getElementById('newSystemResult');
            
            if (!address) {
                showResult(resultDiv, 'âŒ Please enter a wallet address', 'error');
                return;
            }
            
            showResult(resultDiv, 'ğŸ”„ Testing new referral system...', '');
            
            try {
                const response = await fetch(`${API_BASE}/api/referral-system-complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: address,
                        force: false,
                        trigger: 'test'
                    })
                });
                
                const data = await response.json();
                
                let result = `ğŸ¯ NEW REFERRAL SYSTEM RESULT:\n\n`;
                result += `Success: ${data.success}\n`;
                result += `Message: ${data.message || 'No message'}\n`;
                result += `Referral Completed: ${data.referral_completed || false}\n`;
                
                if (data.reward_details) {
                    result += `\nğŸ REWARD DETAILS:\n`;
                    result += `Referrer: ${data.reward_details.referrer_address}\n`;
                    result += `Gold Reward: ${data.reward_details.gold_reward}\n`;
                    result += `Pickaxe Reward: ${data.reward_details.pickaxe_reward}\n`;
                    result += `Trigger: ${data.reward_details.trigger}\n`;
                }
                
                showResult(resultDiv, result, data.success ? 'success' : 'error');
                
            } catch (error) {
                showResult(resultDiv, `âŒ New system test failed: ${error.message}`, 'error');
            }
        }
        
        function showResult(element, text, type) {
            element.textContent = text;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>