<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Checkpoint System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    .test-section {
      background: #16213e;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      border: 2px solid #0f3460;
    }
    button {
      background: #00adb5;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #00d9ff;
    }
    .result {
      background: #0f3460;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196F3; }
    h1 { color: #00adb5; }
    h2 { color: #00d9ff; }
  </style>
</head>
<body>
  <h1>üéØ Checkpoint System Test Suite</h1>
  <p>This test verifies the new checkpoint-only system (no 30-second syncs)</p>

  <div class="test-section">
    <h2>Test 1: Load Checkpoint on Connect</h2>
    <p>Verify that checkpoint is loaded once from /api/status</p>
    <button onclick="testLoadCheckpoint()">Run Test</button>
    <div id="test1-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 2: Client-Side Gold Calculation</h2>
    <p>Verify gold is calculated client-side from checkpoint</p>
    <button onclick="testClientCalculation()">Run Test</button>
    <div id="test2-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 3: Save Checkpoint on Action</h2>
    <p>Test manual checkpoint save to /api/save-checkpoint</p>
    <button onclick="testSaveCheckpoint()">Run Test</button>
    <div id="test3-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 4: No 30-Second Intervals</h2>
    <p>Verify no setInterval calls are running</p>
    <button onclick="testNoIntervals()">Run Test</button>
    <div id="test4-result" class="result"></div>
  </div>

  <div class="test-section">
    <h2>Test 5: Verify API Endpoints</h2>
    <p>Check that save-checkpoint API exists and works</p>
    <button onclick="testApiEndpoints()">Run Test</button>
    <div id="test5-result" class="result"></div>
  </div>

  <script>
    // Test wallet address for testing
    const TEST_ADDRESS = 'TestWallet123456789';

    async function testLoadCheckpoint() {
      const result = document.getElementById('test1-result');
      result.innerHTML = 'üîÑ Testing checkpoint load...\n';

      try {
        const response = await fetch(`/api/status?address=${TEST_ADDRESS}`);
        const data = await response.json();

        result.innerHTML += `\n‚úÖ Status API Response:\n${JSON.stringify(data, null, 2)}\n`;
        
        if (data.checkpoint) {
          result.innerHTML += `\n<span class="success">‚úÖ PASS: Checkpoint data found</span>\n`;
          result.innerHTML += `   - Mining Power: ${data.checkpoint.total_mining_power || 0}\n`;
          result.innerHTML += `   - Last Gold: ${data.checkpoint.last_checkpoint_gold || 0}\n`;
          result.innerHTML += `   - Timestamp: ${data.checkpoint.checkpoint_timestamp || 'N/A'}\n`;
        } else {
          result.innerHTML += `\n<span class="info">‚ÑπÔ∏è INFO: No checkpoint (new user)</span>\n`;
        }
      } catch (error) {
        result.innerHTML += `\n<span class="error">‚ùå FAIL: ${error.message}</span>\n`;
      }
    }

    async function testClientCalculation() {
      const result = document.getElementById('test2-result');
      result.innerHTML = 'üîÑ Testing client-side calculation...\n';

      try {
        // Simulate checkpoint data
        const checkpoint = {
          total_mining_power: 100, // 100 gold/min
          last_checkpoint_gold: 1000,
          checkpoint_timestamp: Math.floor(Date.now() / 1000) - 60 // 1 minute ago
        };

        result.innerHTML += `\nüìä Test Checkpoint:\n${JSON.stringify(checkpoint, null, 2)}\n`;

        // Calculate expected gold (should be 1000 + 100 after 1 minute)
        const currentTime = Math.floor(Date.now() / 1000);
        const timeSince = currentTime - checkpoint.checkpoint_timestamp;
        const goldPerSecond = checkpoint.total_mining_power / 60;
        const minedGold = goldPerSecond * timeSince;
        const totalGold = checkpoint.last_checkpoint_gold + minedGold;

        result.innerHTML += `\n‚úÖ Calculation Results:\n`;
        result.innerHTML += `   - Time Elapsed: ${timeSince} seconds\n`;
        result.innerHTML += `   - Gold/Second: ${goldPerSecond.toFixed(4)}\n`;
        result.innerHTML += `   - Gold Mined: ${minedGold.toFixed(2)}\n`;
        result.innerHTML += `   - Total Gold: ${totalGold.toFixed(2)}\n`;
        
        if (Math.abs(totalGold - 1100) < 5) {
          result.innerHTML += `\n<span class="success">‚úÖ PASS: Calculation accurate (~1100 gold expected)</span>\n`;
        } else {
          result.innerHTML += `\n<span class="error">‚ùå FAIL: Unexpected result (expected ~1100)</span>\n`;
        }
      } catch (error) {
        result.innerHTML += `\n<span class="error">‚ùå FAIL: ${error.message}</span>\n`;
      }
    }

    async function testSaveCheckpoint() {
      const result = document.getElementById('test3-result');
      result.innerHTML = 'üîÑ Testing checkpoint save...\n';

      try {
        const testData = {
          address: TEST_ADDRESS,
          gold: 5000.50,
          timestamp: Math.floor(Date.now() / 1000),
          finalSync: false
        };

        result.innerHTML += `\nüì§ Sending checkpoint:\n${JSON.stringify(testData, null, 2)}\n`;

        const response = await fetch('/api/save-checkpoint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testData)
        });

        const data = await response.json();

        result.innerHTML += `\nüì• Response:\n${JSON.stringify(data, null, 2)}\n`;

        if (data.success) {
          result.innerHTML += `\n<span class="success">‚úÖ PASS: Checkpoint saved successfully</span>\n`;
        } else {
          result.innerHTML += `\n<span class="error">‚ùå FAIL: ${data.error}</span>\n`;
        }
      } catch (error) {
        result.innerHTML += `\n<span class="error">‚ùå FAIL: ${error.message}</span>\n`;
      }
    }

    function testNoIntervals() {
      const result = document.getElementById('test4-result');
      result.innerHTML = 'üîÑ Checking for active intervals...\n';

      // Check if setInterval is being called excessively
      let intervalCount = 0;
      const originalSetInterval = window.setInterval;
      
      window.setInterval = function(...args) {
        intervalCount++;
        result.innerHTML += `\n‚ö†Ô∏è setInterval called: ${args[1]}ms\n`;
        return originalSetInterval.apply(this, args);
      };

      setTimeout(() => {
        window.setInterval = originalSetInterval;
        
        if (intervalCount === 0) {
          result.innerHTML += `\n<span class="success">‚úÖ PASS: No setInterval calls detected</span>\n`;
        } else {
          result.innerHTML += `\n<span class="info">‚ÑπÔ∏è INFO: ${intervalCount} setInterval calls detected</span>\n`;
          result.innerHTML += `   (Check if these are necessary)\n`;
        }
      }, 2000);

      result.innerHTML += `\n‚è≥ Monitoring for 2 seconds...\n`;
    }

    async function testApiEndpoints() {
      const result = document.getElementById('test5-result');
      result.innerHTML = 'üîÑ Testing API endpoints...\n';

      const endpoints = [
        { name: 'Status API', url: '/api/status?address=test', method: 'GET' },
        { name: 'Save Checkpoint API', url: '/api/save-checkpoint', method: 'POST' }
      ];

      for (const endpoint of endpoints) {
        try {
          result.innerHTML += `\nüì° Testing ${endpoint.name}...\n`;
          
          const options = { method: endpoint.method };
          if (endpoint.method === 'POST') {
            options.headers = { 'Content-Type': 'application/json' };
            options.body = JSON.stringify({
              address: 'test',
              gold: 100,
              timestamp: Math.floor(Date.now() / 1000)
            });
          }

          const response = await fetch(endpoint.url, options);
          
          result.innerHTML += `   Status: ${response.status} ${response.statusText}\n`;
          
          if (response.ok) {
            result.innerHTML += `   <span class="success">‚úÖ Endpoint available</span>\n`;
          } else {
            result.innerHTML += `   <span class="error">‚ùå Endpoint error</span>\n`;
          }
        } catch (error) {
          result.innerHTML += `   <span class="error">‚ùå ${error.message}</span>\n`;
        }
      }

      result.innerHTML += `\n<span class="success">‚úÖ COMPLETE: API endpoint test finished</span>\n`;
    }

    // Run all tests on load
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üß™ Checkpoint System Test Suite Ready');
      console.log('üìã Click buttons to run individual tests');
    });
  </script>
</body>
</html>
